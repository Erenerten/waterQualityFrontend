<!-- public/dashboard/dashboard.html -->
<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>SuKaliteX | Canlı Su Kalitesi Paneli</title>
    <meta http-equiv="Cache-Control" content="no-store" />

    <!-- libs -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
      :root{
        --dark:#0a2342;--gray:#f8fafc;--text:#223;--accent:#00b4d8;
        --success:#2ecc71;--warning:#f39c12;--danger:#e74c3c
      }
      *{margin:0;padding:0;box-sizing:border-box}
      body{font-family:Poppins,sans-serif;background:var(--gray);color:var(--text);
           display:flex;height:100vh;overflow:hidden}

      /* sidebar ---------------------------------------------------- */
      .sidebar{width:250px;background:var(--dark);color:#fff;padding:20px 16px;
               display:flex;flex-direction:column;gap:18px}
      .logo{display:flex;align-items:center;font-weight:600;font-size:1.3rem}
      .logo img{height:52px;margin-right:10px}
      .sensor-container{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:12px}
      .sensor-box{background:rgba(255,255,255,.08);padding:14px;border-radius:10px;
                  cursor:pointer;border-left:3px solid var(--accent);transition:.25s}
      .sensor-box.active{border-left-color:var(--success);background:rgba(0,180,216,.18)}
      .sensor-header{display:flex;justify-content:space-between;align-items:center}
      .sensor-value{font-size:1.3rem;font-weight:600;margin:4px 0}
      .sensor-unit{font-size:.75rem;opacity:.8}
      .sensor-status{font-size:.65rem;padding:2px 6px;border-radius:14px}
      .status-normal{background:var(--success)}
      .status-warning{background:var(--warning)}
      .status-danger{background:var(--danger)}

      /* layout ------------------------------------------------------ */
      .main{flex:1;display:flex;flex-direction:column}
      .top-bar{padding:10px 20px;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.05);
               display:flex;justify-content:space-between;align-items:center}
      .content{flex:1;display:flex;overflow:hidden}
      .map-wrap{flex:1.1;min-width:360px}
      #map{width:100%;height:100%}
      .chart-wrap{flex:1;padding:18px 20px;background:#fff;display:flex;flex-direction:column}
      #sensorChart{flex:1}
      .chart-title{font-size:1.1rem;margin-bottom:10px}
      .chart-box{flex:1;position:relative;min-height:240px}
      .sensor-info{margin-top:16px;display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
      .info-card{background:var(--gray);padding:10px;border-radius:8px;font-size:.82rem}

      /* toast ------------------------------------------------------- */
      .toast{position:fixed;bottom:20px;right:20px;background:var(--dark);color:#fff;
             padding:14px 18px;border-radius:6px;transform:translateX(120%);
             transition:.35s;z-index:1000}
      .toast.show{transform:translateX(0)}
    </style>
  </head>

  <body>
    <!-- ----------------------------- sidebar ------------------- -->
    <aside class="sidebar">
      <div class="logo"><img src="/images/logo.png" alt="logo"><span>SuKaliteX</span></div>

      <div class="sensor-container">
        <div class="sensor-box active" data-type="temperature"  onclick="selectSensor('temperature',event)">
          <div class="sensor-header"><h4>Sıcaklık</h4><span class="sensor-status status-normal">—</span></div>
          <div class="sensor-value">-- <span class="sensor-unit">°C</span></div>
        </div>

        <div class="sensor-box" data-type="tds" onclick="selectSensor('tds',event)">
          <div class="sensor-header"><h4>TDS</h4><span class="sensor-status status-normal">—</span></div>
          <div class="sensor-value">-- <span class="sensor-unit">ppm</span></div>
        </div>

        <div class="sensor-box" data-type="turbidity" onclick="selectSensor('turbidity',event)">
          <div class="sensor-header"><h4>Bulanıklık</h4><span class="sensor-status status-normal">—</span></div>
          <div class="sensor-value">-- <span class="sensor-unit">NTU</span></div>
        </div>

        <div class="sensor-box" data-type="battery" onclick="selectSensor('battery',event)">
          <div class="sensor-header"><h4>Batarya</h4><span class="sensor-status status-normal">—</span></div>
          <div class="sensor-value">-- <span class="sensor-unit">%</span></div>
        </div>
      </div>
    </aside>

    <!-- ----------------------------- main ----------------------- -->
    <section class="main">
      <div class="top-bar">
        <span id="clock">--:--</span>
      </div>

      <div class="content">
        <div class="map-wrap"><div id="map"></div></div>

        <div class="chart-wrap">
          <div class="chart-title" id="chartTitle">Sıcaklık Verileri</div>
          <div class="chart-box"><canvas id="sensorChart"></canvas></div>

          <div class="sensor-info">
            <div class="info-card">Son Ölçüm: <span id="lastVal">--</span></div>
            <div class="info-card">Ortalama: <span id="avgVal">--</span></div>
            <div class="info-card">Min: <span id="minVal">--</span></div>
            <div class="info-card">Maks: <span id="maxVal">--</span></div>
          </div>
        </div>
      </div>
    </section>

    <div class="toast" id="toast"><span id="toastMsg"></span></div>

    <!-- --------------------------- script ----------------------- -->
    <script>
      /* --------------------------------------------------------- *
       *  CONFIG & SMALL HELPERS
       * --------------------------------------------------------- */
      const TOKEN = localStorage.getItem('token');
      if (!TOKEN) location.href = '/dashboard/login.html';

      const SENSOR_LIST = ['temperature','tds','turbidity','battery'];
      const displayName = {
        temperature:'Sıcaklık Verileri',
        tds        :'TDS Verileri',
        turbidity  :'Bulanıklık Verileri',
        battery    :'Batarya Seviyesi'
      };
      /* backend occasionally uses “conductivity” – map it to tds   */
      const alias = { conductivity:'tds' };
      const history = Object.fromEntries(SENSOR_LIST.map(k=>[k,[]])); // [ [time,val] …]
      const MAX_PTS = 120;

      /* toast */
      const toast = msg=>{
        const el=document.getElementById('toast');
        document.getElementById('toastMsg').textContent=msg;
        el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),3000);
      };

      /* --------------------------------------------------------- *
       *  CLOCK
       * --------------------------------------------------------- */
      setInterval(()=>document.getElementById('clock').textContent=
        new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}),
        1000);

      /* --------------------------------------------------------- *
       *  MAP (just a marker)
       * --------------------------------------------------------- */
      const map = L.map('map').setView([41.03,28.89], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { attribution:'© OpenStreetMap' }).addTo(map);
      L.marker([41.03,28.89]).addTo(map).bindPopup('Ölçüm Noktası');

      /* --------------------------------------------------------- *
       *  CHART
       * --------------------------------------------------------- */
      const ctx = document.getElementById('sensorChart').getContext('2d');
      const chart = new Chart(ctx,{
        type:'line',
        data:{labels:[],datasets:[{data:[],borderColor:'#0066cc',
               borderWidth:2,tension:.38,fill:false,pointRadius:3}]},
        options:{plugins:{legend:{display:false}},
          scales:{x:{grid:{display:false}}}}
      });

      let activeSensor='temperature';

      function redraw() {
        const series = history[activeSensor];
        chart.data.labels = series.map(p=>p[0]);
        chart.data.datasets[0].data = series.map(p=>p[1]);
        chart.options.scales.y.title = {
          display:true,
          text: activeSensor==='temperature' ? '°C' :
                activeSensor==='tds'         ? 'ppm' :
                activeSensor==='turbidity'   ? 'NTU' : '%'
        };
        chart.update();

        /* update stats */
        const vals = series.map(p=>p[1]);
        const fmt  = n=>Number.isFinite(n)? n.toFixed(1):'--';
        document.getElementById('lastVal').textContent = fmt(vals.at(-1));
        document.getElementById('avgVal' ).textContent = fmt(vals.reduce((a,b)=>a+b,0)/vals.length);
        document.getElementById('minVal' ).textContent = fmt(Math.min(...vals));
        document.getElementById('maxVal' ).textContent = fmt(Math.max(...vals));
      }

      function pushPoint(type,val){
        const arr=history[type];
        arr.push([new Date().toLocaleTimeString('tr-TR'), val]);
        if(arr.length>MAX_PTS) arr.shift();
        if(type===activeSensor) redraw();
      }

      /* --------------------------------------------------------- *
       *  SIDEBAR
       * --------------------------------------------------------- */
      function updateSidebar(type,val){
        const box=document.querySelector(`.sensor-box[data-type="${type}"]`);
        if(!box) return;
        box.querySelector('.sensor-value').innerHTML =
          `${val.toFixed(1)} <span class="sensor-unit">${
            type==='temperature'?'°C':type==='tds'?'ppm':type==='battery'?'%':'NTU'}</span>`;

        const st = box.querySelector('.sensor-status');
        if(!st) return;
        let text='Normal', css='status-normal';
        if(type==='temperature'){
          if(val>26)      [text,css]=['Tehlikeli','status-danger'];
          else if(val>24) [text,css]=['Yüksek'   ,'status-warning'];
        }else if(type==='tds' && val>1000){
          [text,css]=['Yüksek','status-warning'];
        }else if(type==='battery' && val<20){
          [text,css]=['Düşük','status-warning'];
        }
        st.textContent=text; st.className=`sensor-status ${css}`;
      }

      function selectSensor(t,e){
        document.querySelectorAll('.sensor-box').forEach(b=>b.classList.remove('active'));
        e.currentTarget.classList.add('active');
        activeSensor=t;
        document.getElementById('chartTitle').textContent = displayName[t];
        redraw();
      }

      /* --------------------------------------------------------- *
       *  FETCH LOOP
       * --------------------------------------------------------- */
      async function poll(){
        try{
          const r = await fetch('/api/sensor-data',{headers:{Authorization:'Bearer '+TOKEN}});
          if(!r.ok) throw new Error('HTTP '+r.status);
          const rows = await r.json();                      // [{type,value,timestamp},…]
          rows.forEach(row=>{
            const type = alias[row.type] || row.type;       // normalise
            if(!history[type]) return;                      // skip unknown
            const v = Number(row.value);
            if(!Number.isFinite(v)) return;
            pushPoint(type,v); updateSidebar(type,v);
          });
        }catch(err){
          console.error(err); toast('Veri alınamadı');
        }
      }
      setInterval(poll, 10000);
      poll();  /* first call */
    </script>
  </body>
</html>
