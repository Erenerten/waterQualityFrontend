<!-- public/dashboard/dashboard.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>SuKaliteX Pro | Akıllı Su Kalitesi İzleme Paneli</title>
  <meta http-equiv="Cache-Control" content="no-store" />

  <!-- Fonts & libs -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>

  <!-- Styles (unchanged apart from comments trimmed) -->
  <style>
    :root{--primary:#0066cc;--primary-dark:#0052a3;--primary-light:#e6f2ff;--accent:#00b4d8;--accent-dark:#0093b8;--light:#ffffff;--dark:#0a2342;--gray:#f8fafc;--gray-dark:#e9ecef;--text:#2d3748;--text-light:#6c757d;--success:#2ecc71;--warning:#f39c12;--danger:#e74c3c}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Poppins,sans-serif;background:var(--gray);color:var(--text);display:flex;height:100vh;overflow:hidden}
    .sidebar{width:280px;background:var(--dark);color:#fff;padding:20px;display:flex;flex-direction:column;box-shadow:4px 0 15px rgba(0,0,0,.1);transition:.3s}
    .sidebar.collapsed{width:80px}
    .sidebar.collapsed .logo span,.sidebar.collapsed .sensor-box h3,.sidebar.collapsed .sensor-unit,.sidebar.collapsed .sensor-status{display:none}
    .sidebar.collapsed .sensor-box{padding:10px;text-align:center}
    .sidebar.collapsed .sensor-value{font-size:1rem}
    .logo{display:flex;align-items:center;margin-bottom:30px;font-size:1.4rem;font-weight:600;cursor:pointer}
    .logo i{margin-right:10px;color:var(--accent);font-size:1.6rem}
    .toggle-sidebar{position:absolute;right:-15px;top:20px;background:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 0 5px rgba(0,0,0,.2);cursor:pointer;z-index:20}
    .sensor-container{display:flex;flex-direction:column;gap:12px;flex-grow:1;overflow-y:auto;padding-right:5px}
    .sensor-box{background:rgba(255,255,255,.08);padding:15px;border-radius:10px;cursor:pointer;transition:.3s;border-left:3px solid var(--accent)}
    .sensor-box:hover{background:rgba(255,255,255,.12)}
    .sensor-box.active{background:rgba(0,180,216,.15);border-left-color:var(--success)}
    .sensor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .sensor-box h3{margin:0;font-size:.95rem;font-weight:500;color:rgba(255,255,255,.9)}
    .sensor-value{font-size:1.4rem;font-weight:600;margin:3px 0;color:#fff}
    .sensor-unit{font-size:.85rem;opacity:.7}
    .sensor-status{display:inline-block;padding:3px 8px;border-radius:20px;font-size:.7rem;font-weight:600;text-transform:uppercase}
    .status-normal{background:var(--success)}
    .status-warning{background:var(--warning)}
    .status-danger{background:var(--danger)}
    .main-content{flex-grow:1;display:flex;flex-direction:column;position:relative}
    .top-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    .battery-loader{display:flex;align-items:center;gap:10px}
    .loader{width:60px;height:30px;border:2px solid var(--success);border-right-color:transparent;padding:2px;background:repeating-linear-gradient(90deg,var(--success)0 8px,#0000 0 12px)left/0% 100% no-repeat content-box;position:relative}
    .loader::before{content:"";position:absolute;top:-2px;bottom:-2px;left:100%;width:8px;background:linear-gradient(#0000 calc(50% - 5px),var(--success)0 calc(50% - 4px),#0000 0 calc(50% + 4px),var(--success)0 calc(50% + 5px),#0000 0)left/100% 100%,linear-gradient(var(--success) calc(50% - 4px),#0000 0 calc(50% + 4px),var(--success) 0)left/2px 100%,linear-gradient(#0000 calc(50% - 4px),var(--success) 0 calc(50% + 4px),#0000 0)right/2px 100%;background-repeat:no-repeat}
    .battery-percent{font-size:.9rem;font-weight:500;color:var(--dark)}
    .content-area{display:flex;flex-grow:1;overflow:hidden}
    .map-container{width:60%;height:100%;position:relative}
    #map{height:100%;width:100%;background:#0a2342}
    .graph-container{width:40%;padding:20px;background:#fff;display:flex;flex-direction:column}
    .graph-title{font-size:1.2rem;margin-bottom:15px;color:var(--dark);font-weight:600;display:flex;justify-content:space-between;align-items:center}
    .chart-wrapper{flex-grow:1;position:relative}
    .chart-container{position:absolute;width:100%;height:100%}
    .sensor-info{margin-top:20px;display:grid;grid-template-columns:repeat(2,1fr);gap:15px}
    .info-card{background:var(--gray);padding:12px;border-radius:8px;transition:.3s}
    .info-card:hover{transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .info-card h4{font-size:.8rem;color:var(--text-light);margin-bottom:5px}
    .info-card p{font-size:1.1rem;font-weight:600;color:var(--dark)}
    .notification{position:fixed;bottom:20px;right:20px;background:var(--dark);color:#fff;padding:15px;border-radius:5px;box-shadow:0 0 20px rgba(0,0,0,.2);transform:translateX(200%);transition:.3s;z-index:1000}
    .notification.show{transform:translateX(0)}
    @media (max-width:992px){.content-area{flex-direction:column}.map-container,.graph-container{width:100%}.map-container{height:50vh}}
    @media (max-width:768px){body{flex-direction:column;height:auto}.sidebar{width:100%;padding:15px}.sensor-container{flex-direction:row;overflow-x:auto;padding-bottom:10px}.sensor-box{min-width:160px}}
  </style>
</head>

<body>
  <!-- ===== Sidebar ====================================================== -->
  <div class="sidebar">
    <div class="toggle-sidebar" onclick="toggleSidebar()">
      <i class="fas fa-chevron-left"></i>
    </div>
    <div class="logo" onclick="toggleSidebar()">
      <img src="images/logo.png" alt="SuKaliteX Logo" style="height:60px;margin-right:10px" />
      <span>SuKaliteX</span>
    </div>

    <div class="sensor-container">
      <!-- Temperature -->
      <div class="sensor-box active" data-type="temperature" onclick="showSensorDetails('temperature', event)">
        <div class="sensor-header">
          <h3><i class="fas fa-thermometer-half"></i> Su Sıcaklığı</h3>
          <span class="sensor-status status-normal">Normal</span>
        </div>
        <div class="sensor-value">-- <span class="sensor-unit">°C</span></div>
      </div>
      <!-- Turbidity -->
      <div class="sensor-box" data-type="turbidity" onclick="showSensorDetails('turbidity', event)">
        <div class="sensor-header">
          <h3><i class="fas fa-water"></i> Bulanıklık</h3>
          <span class="sensor-status status-normal">Normal</span>
        </div>
        <div class="sensor-value">-- <span class="sensor-unit">NTU</span></div>
      </div>
      <!-- Conductivity / TDS -->
      <div class="sensor-box" data-type="conductivity" onclick="showSensorDetails('conductivity', event)">
        <div class="sensor-header">
          <h3><i class="fas fa-bolt"></i> TDS / İletkenlik</h3>
          <span class="sensor-status status-normal">Normal</span>
        </div>
        <div class="sensor-value">-- <span class="sensor-unit">ppm</span></div>
      </div>
    </div>
  </div>

  <!-- ===== Main content ================================================ -->
  <div class="main-content">
    <div class="top-bar">
      <div class="time-display"><i class="far fa-clock"></i> <span id="current-time">--:--</span></div>
      <div class="battery-loader">
        <div class="battery-percent">87%</div>
        <div class="loader"></div>
      </div>
    </div>

    <div class="content-area">
      <!-- Map -->
      <div class="map-container">
        <div id="map"></div>
        <div class="map-controls">
          <button type="button" onclick="toggleHeatmap()"><i class="fas fa-fire"></i> Isı Haritası</button>
          <button type="button" onclick="centerMap()"><i class="fas fa-crosshairs"></i> Merkezle</button>
          <button type="button" onclick="showAllSensors()"><i class="fas fa-map-marker-alt"></i> Tüm Sensörler</button>
        </div>
      </div>

      <!-- Chart & details -->
      <div class="graph-container">
        <h3 class="graph-title">
          <span id="graph-title">Su Sıcaklığı Verileri</span>
          <span>
            <select id="time-range" onchange="updateChartRange()">
              <option value="24">Son 24 Saat</option>
              <option value="168">Son 7 Gün</option>
              <option value="720">Son 30 Gün</option>
            </select>
          </span>
        </h3>

        <div class="chart-wrapper"><div class="chart-container"><canvas id="sensorChart"></canvas></div></div>

        <div class="sensor-info">
          <div class="info-card"><h4>Son Ölçüm</h4><p id="detail-last">--</p></div>
          <div class="info-card"><h4>Ortalama</h4><p id="detail-avg">--</p></div>
          <div class="info-card"><h4>Minimum</h4><p id="detail-min">--</p></div>
          <div class="info-card"><h4>Maksimum</h4><p id="detail-max">--</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating toast -->
  <div class="notification" id="notification"><div id="notification-message">---</div></div>

  <!-- ================== Scripts ======================================== -->
  <script>
    /*--------------------------------------------------------------------
     *  AUTH & BASIC UTILITIES
     *------------------------------------------------------------------*/
    const token = localStorage.getItem('token');
    if (!token) location.href = '/dashboard/login.html';

    const notify = msg => {
      const n = document.getElementById('notification');
      document.getElementById('notification-message').textContent = msg;
      n.classList.add('show');
      setTimeout(() => n.classList.remove('show'), 3000);
    };

    /*--------------------------------------------------------------------
     *  MAP INITIALISATION
     *------------------------------------------------------------------*/
    let map, heatmapLayer, isHeatmapVisible = false;
    const sensorMarkers = [];

    function initMap() {
      const center = [41.0288603, 28.8877531];
      map = L.map('map').setView(center, 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors', maxZoom: 18
      }).addTo(map);

      L.circleMarker(center, {
        radius: 12, fillColor: '#0066cc', color: '#fff', weight: 3, fillOpacity: 1
      }).addTo(map).bindPopup('<b>ÖLÇÜM PROBU-1</b><br>Ana İzleme Noktası').openPopup();

      heatmapLayer = L.heatLayer([], { radius: 25, blur: 15, maxZoom: 17, gradient: { .4: 'blue', .6: 'lime', .8: 'yellow', 1: 'red' } });
    }

    /*--------------------------------------------------------------------
     *  SIDEBAR / UI HELPERS
     *------------------------------------------------------------------*/
    let sidebarCollapsed = false;
    function toggleSidebar() {
      const sb = document.querySelector('.sidebar');
      sb.classList.toggle('collapsed');
      sidebarCollapsed = !sidebarCollapsed;
      const icon = document.querySelector('.toggle-sidebar i');
      icon.classList.toggle('fa-chevron-left', !sidebarCollapsed);
      icon.classList.toggle('fa-chevron-right', sidebarCollapsed);
    }

    function updateSidebar(sensorType, value) {
      if (value == null) return;
      const box = document.querySelector(`.sensor-box[data-type="${sensorType}"]`);
      if (!box) return;
      const unit = box.querySelector('.sensor-unit').textContent.trim();
      box.querySelector('.sensor-value').innerHTML = `${Number(value).toFixed(1)} ${unit}`;
      const statusEl = box.querySelector('.sensor-status');
      if (sensorType === 'temperature') {
        if (value > 26) { statusEl.textContent = 'Tehlikeli'; statusEl.className = 'sensor-status status-danger'; }
        else if (value > 24) { statusEl.textContent = 'Yüksek'; statusEl.className = 'sensor-status status-warning'; }
        else { statusEl.textContent = 'Normal'; statusEl.className = 'sensor-status status-normal'; }
      } else if (sensorType === 'conductivity') {
        if (value > 1000) { statusEl.textContent = 'Yüksek'; statusEl.className = 'sensor-status status-warning'; }
        else { statusEl.textContent = 'Normal'; statusEl.className = 'sensor-status status-normal'; }
      }
    }

    /*--------------------------------------------------------------------
     *  CHART (default: temperature)
     *------------------------------------------------------------------*/
    const sensorCtx = document.getElementById('sensorChart').getContext('2d');
    const sensorChart = new Chart(sensorCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ data: [], borderColor: '#0066cc', borderWidth: 2, tension: .4, fill: false, pointRadius: 0, pointHoverRadius: 5 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: false, title: { display: true, text: 'Sıcaklık (°C)' } }, x: { title: { display: true, text: 'Zaman' }, grid: { display: false } } }
      }
    });

    function pushChartValue(val) {
      const now = new Date().toLocaleTimeString('tr-TR');
      sensorChart.data.labels.push(now);
      sensorChart.data.datasets[0].data.push(val);
      if (sensorChart.data.labels.length > 30) {
        sensorChart.data.labels.shift(); sensorChart.data.datasets[0].data.shift();
      }
      sensorChart.update();
    }

    /*--------------------------------------------------------------------
     *  DATA FETCH (poll every 10 s)
     *------------------------------------------------------------------*/
    async function fetchLiveData() {
      try {
        const res = await fetch('/api/sensor-data', { headers: { Authorization: 'Bearer ' + token } });
        if (!res.ok) throw new Error('fetch error ' + res.status);
        const data = await res.json(); // expected [{type,value,timestamp}, ...]
        applySensorUpdate(data);
      } catch (e) {
        console.error('Fetch failed:', e.message);
        notify('Veri alınamadı');
      }
    }

    function applySensorUpdate(arr) {
      if (!Array.isArray(arr) || arr.length === 0) return;
      const grouped = Object.fromEntries(arr.map(d => [d.type, d]));
      ['temperature', 'turbidity', 'conductivity'].forEach(t => {
        if (grouped[t]) {
          const v = grouped[t].value;
          updateSidebar(t, v);
          if (t === 'temperature') pushChartValue(v);
        }
      });
      updateHeatmap();
    }

    /*--------------------------------------------------------------------
     *  HEATMAP HELPERS
     *------------------------------------------------------------------*/
    function updateHeatmap() {
      const pts = sensorMarkers.map(s => [s.lat, s.lng, (s.value || 22) / 10]);
      heatmapLayer.setLatLngs(pts);
    }
    function toggleHeatmap() { isHeatmapVisible ? map.removeLayer(heatmapLayer) : map.addLayer(heatmapLayer); isHeatmapVisible = !isHeatmapVisible; }
    const centerMap = () => map.setView(map.getCenter(), 15);
    const showAllSensors = () => {
      if (sensorMarkers.length === 0) return;
      map.fitBounds(L.featureGroup(sensorMarkers.map(s => s.marker)).getBounds().pad(.2));
    };

    /*--------------------------------------------------------------------
     *  OTHER UI
     *------------------------------------------------------------------*/
    function updateTime() { document.getElementById('current-time').textContent = new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }); }
    setInterval(updateTime, 1000);

    function showSensorDetails(type, evt) {
      document.querySelectorAll('.sensor-box').forEach(b => b.classList.remove('active'));
      evt.currentTarget.classList.add('active');
      document.getElementById('graph-title').textContent = {
        temperature: 'Su Sıcaklığı Verileri', turbidity: 'Bulanıklık Verileri', conductivity: 'TDS / İletkenlik Verileri'
      }[type];
    }

    const updateChartRange = () => {};

    /*--------------------------------------------------------------------
     *  BOOTSTRAP
     *------------------------------------------------------------------*/
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      updateTime();
      fetchLiveData();
      setInterval(fetchLiveData, 10000);
      notify('Sistem başlatıldı – REST polling aktif');
    });
  </script>
</body>
</html>