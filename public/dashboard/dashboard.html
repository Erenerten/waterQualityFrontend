<!--  public/dashboard/dashboard.html  -->
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>SuKaliteX Pro | Akıllı Su Kalitesi İzleme Paneli</title>
  <meta http-equiv="Cache-Control" content="no-store" />

  <!-- fonts & libs -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>

  <!-- styles (identical layout, just added .chart-wrapper min-height) -->
  <style>
    :root{
      --primary:#0066cc;--dark:#0a2342;--gray:#f8fafc;--text:#2d3748;
      --accent:#00b4d8;--success:#2ecc71;--warning:#f39c12;--danger:#e74c3c
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Poppins,sans-serif;background:var(--gray);color:var(--text);
         display:flex;height:100vh;overflow:hidden}

    /* ─── sidebar ────────────────────────────────────────────────── */
    .sidebar{width:280px;background:var(--dark);color:#fff;padding:20px;
             display:flex;flex-direction:column;transition:.3s}
    .sidebar.collapsed{width:80px}
    .sidebar.collapsed .logo span,
    .sidebar.collapsed .sensor-box h3,
    .sidebar.collapsed .sensor-unit,
    .sidebar.collapsed .sensor-status{display:none}
    .logo{display:flex;align-items:center;margin-bottom:30px;font-size:1.4rem;
          font-weight:600;cursor:pointer}
    .logo img{height:60px;margin-right:10px}
    .sensor-container{display:flex;flex-direction:column;gap:12px;
                      flex:1;overflow-y:auto}
    .sensor-box{background:rgba(255,255,255,.08);padding:15px;border-radius:10px;
                border-left:3px solid var(--accent);cursor:pointer;transition:.3s}
    .sensor-box:hover{background:rgba(255,255,255,.12)}
    .sensor-box.active{border-left-color:var(--success)}
    .sensor-header{display:flex;justify-content:space-between;align-items:center}
    .sensor-value{font-size:1.4rem;font-weight:600;margin:3px 0;color:#fff}
    .sensor-unit{font-size:.8rem;opacity:.8}
    .sensor-status{padding:3px 8px;border-radius:20px;font-size:.7rem}
    .status-normal{background:var(--success)}
    .status-warning{background:var(--warning)}
    .status-danger{background:var(--danger)}

    /* ─── main / top bar ─────────────────────────────────────────── */
    .main-content{flex:1;display:flex;flex-direction:column}
    .top-bar{display:flex;justify-content:space-between;align-items:center;
             padding:12px 20px;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    .content-area{flex:1;display:flex;overflow:hidden}

    /* map & chart areas */
    .map-container{width:60%;height:100%}
    #map{height:100%;width:100%}
    .graph-container{width:40%;display:flex;flex-direction:column;background:#fff;
                     padding:20px}
    .graph-container h3{font-size:1.2rem;margin-bottom:15px}

    .chart-wrapper{flex:1;position:relative;min-height:260px}
    .chart-container{position:absolute;inset:0}

    .sensor-info{margin-top:20px;display:grid;gap:15px;grid-template-columns:repeat(2,1fr)}
    .info-card{background:var(--gray);padding:12px;border-radius:8px}

    /* toast */
    .notification{position:fixed;bottom:20px;right:20px;background:var(--dark);
                  color:#fff;padding:15px;border-radius:5px;transform:translateX(200%);
                  transition:.3s;z-index:1000}
    .notification.show{transform:translateX(0)}
  </style>
</head>

<body>
  <!-- ───────────────────────── sidebar ────────────────────────── -->
  <div class="sidebar">
    <div class="logo">
      <img src="/images/logo.png" alt="logo"><span>SuKaliteX</span>
    </div>

    <div class="sensor-container">
      <div class="sensor-box active" data-type="temperature"
           onclick="showSensorDetails('temperature',event)">
        <div class="sensor-header">
          <h3><i class="fas fa-thermometer-half"></i> Su Sıcaklığı</h3>
          <span class="sensor-status status-normal">Normal</span>
        </div>
        <div class="sensor-value">-- <span class="sensor-unit">°C</span></div>
      </div>

      <div class="sensor-box" data-type="turbidity"
           onclick="showSensorDetails('turbidity',event)">
        <div class="sensor-header">
          <h3><i class="fas fa-water"></i> Bulanıklık</h3>
          <span class="sensor-status status-normal">Normal</span>
        </div>
        <div class="sensor-value">-- <span class="sensor-unit">NTU</span></div>
      </div>

      <div class="sensor-box" data-type="conductivity"
           onclick="showSensorDetails('conductivity',event)">
        <div class="sensor-header">
          <h3><i class="fas fa-bolt"></i> TDS / İletkenlik</h3>
          <span class="sensor-status status-normal">Normal</span>
        </div>
        <div class="sensor-value">-- <span class="sensor-unit">ppm</span></div>
      </div>
    </div>
  </div>

  <!-- ───────────────────────── main content ───────────────────── -->
  <div class="main-content">
    <div class="top-bar">
      <span id="current-time">--:--</span>
    </div>

    <div class="content-area">
      <div class="map-container"><div id="map"></div></div>

      <div class="graph-container">
        <h3 id="graph-title">Su Sıcaklığı Verileri</h3>

        <div class="chart-wrapper">
          <div class="chart-container">
            <canvas id="sensorChart"></canvas>
          </div>
        </div>

        <div class="sensor-info">
          <div class="info-card"><p id="detail-last">--</p></div>
          <div class="info-card"><p id="detail-avg">--</p></div>
          <div class="info-card"><p id="detail-min">--</p></div>
          <div class="info-card"><p id="detail-max">--</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- toast -->
  <div class="notification" id="notification">
    <div id="notification-message"></div>
  </div>

  <!-- ───────────────────────── script ─────────────────────────── -->
  <script>
    /*****************************************************************
     *  CONSTANTS & HELPERS
     *****************************************************************/
    const token  = localStorage.getItem('token');
    if (!token) location.href = '/dashboard/login.html';

    const alias = { tds: 'conductivity' };   // backend → frontend name
    const MAX_POINTS = 60;                   // keep N per sensor

    const toast = msg => {
      const n = document.getElementById('notification');
      document.getElementById('notification-message').textContent = msg;
      n.classList.add('show');
      setTimeout(() => n.classList.remove('show'), 3000);
    };

    /*****************************************************************
     *  CHART & IN-MEMORY HISTORY
     *****************************************************************/
    const history = { temperature: [], turbidity: [], conductivity: [] };
    let activeSensor = 'temperature';

    const ctx = document.getElementById('sensorChart').getContext('2d');
    const sensorChart = new Chart(ctx, {
      type : 'line',
      data : { labels: [], datasets: [{
        data: [], borderColor: '#0066cc', borderWidth: 2, tension: .4,
        fill: false, pointRadius: 3, pointHoverRadius: 5
      }]},
      options: { plugins:{ legend:{ display:false } },
        scales:{ x:{ grid:{ display:false } }, y:{ beginAtZero:false } } }
    });

    function addHistory(type, val) {
      const ser = history[type];
      ser.push([new Date().toLocaleTimeString('tr-TR'), val]);
      if (ser.length > MAX_POINTS) ser.shift();
      if (type === activeSensor) drawChart();
    }

    function drawChart() {
      const ser = history[activeSensor];
      sensorChart.data.labels = ser.map(p => p[0]);
      sensorChart.data.datasets[0].data = ser.map(p => p[1]);
      sensorChart.options.scales.y.title = {
        display:true,
        text: activeSensor === 'temperature'  ? 'Sıcaklık (°C)'      :
              activeSensor === 'turbidity'    ? 'Bulanıklık (NTU)'   :
                                                 'TDS / İletkenlik'
      };
      sensorChart.update();
    }

    /*****************************************************************
     *  SIDEBAR UPDATE (null-safe)
     *****************************************************************/
    function updateSidebar(type, val) {
      const box = document.querySelector(`.sensor-box[data-type="${type}"]`);
      if (!box) return;                               // unknown sensor

      const unitEl = box.querySelector('.sensor-unit');
      const valEl  = box.querySelector('.sensor-value');
      if (valEl) valEl.innerHTML =
        `${val.toFixed(1)} ${unitEl ? unitEl.textContent.trim() : ''}`;

      const st = box.querySelector('.sensor-status');
      if (!st) return;

      if (type === 'temperature') {
        st.textContent = val > 26 ? 'Tehlikeli' : val > 24 ? 'Yüksek' : 'Normal';
        st.className   = `sensor-status ${val > 26 ? 'status-danger'
                       : val > 24 ? 'status-warning' : 'status-normal'}`;
      } else if (type === 'conductivity') {
        st.textContent = val > 1000 ? 'Yüksek' : 'Normal';
        st.className   = `sensor-status ${val > 1000 ? 'status-warning'
                       : 'status-normal'}`;
      }
    }

    /*****************************************************************
     *  FETCH LOOP
     *****************************************************************/
    async function fetchLiveData() {
      try {
        const r = await fetch('/api/sensor-data',
          { headers: { Authorization: 'Bearer ' + token } });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const rows = await r.json();                  // [{type,value,…},…]

        rows.forEach(row => {
          const t = alias[row.type] || row.type;
          const v = Number(row.value);
          if (!Number.isFinite(v)) return;           // skip NaN
          updateSidebar(t, v);
          addHistory(t, v);
        });
      } catch (err) {
        console.error(err);
        toast('Veri alınamadı');
      }
    }

    setInterval(fetchLiveData, 10000);
    fetchLiveData();

    /*****************************************************************
     *  UI INTERACTION
     *****************************************************************/
    function showSensorDetails(type, ev) {
      document.querySelectorAll('.sensor-box')
              .forEach(b => b.classList.remove('active'));
      ev.currentTarget.classList.add('active');
      activeSensor = type;
      document.getElementById('graph-title').textContent =
        {temperature :'Su Sıcaklığı Verileri',
         turbidity   :'Bulanıklık Verileri',
         conductivity:'TDS / İletkenlik Verileri'}[type];
      drawChart();
    }

    /* clock */
    setInterval(() => {
      document.getElementById('current-time').textContent =
        new Date().toLocaleTimeString('tr-TR', { hour:'2-digit', minute:'2-digit' });
    }, 1000);

    /* minimal map */
    const map = L.map('map').setView([41.03, 28.89], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '© OpenStreetMap' }).addTo(map);
  </script>
</body>
</html>
