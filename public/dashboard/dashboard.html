<!-- public/dashboard/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard — Water Quality App</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{margin:0;background:#e6f7ff;font-family:Arial,Helvetica,sans-serif}
    /* top bar */
    .header{background:#f0f0f0;padding:12px 24px;display:flex;
            justify-content:space-between;align-items:center;
            box-shadow:0 1px 4px rgba(0,0,0,.1)}
    .title{font-size:1.2rem;font-weight:600;color:#333}
    .header button{margin-left:12px;padding:6px 12px;border:0;border-radius:4px;
                   color:#fff;font-size:.9rem;cursor:pointer}
    .home-btn{background:#1890ff}.home-btn:hover{background:#1073c7}
    .logout-btn{background:#cc0033}.logout-btn:hover{background:#a00028}

    /* layout */
    .main{display:flex;padding:24px;height:calc(100vh - 50px);box-sizing:border-box}
    .chart-container{flex:3;background:#fff;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.1);
                     padding:16px;margin-right:16px;display:flex;flex-direction:column}
    .chart-container h2{margin:0 0 8px;font-size:1rem;color:#333}
    .chart-container canvas{flex:1}
    .slider-container{flex:1;background:#fff;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.1);
                      padding:16px;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .slider-container h3{margin-bottom:12px;font-size:1rem;color:#333;text-align:center}
    .slider-container input{width:100%}
    #timeLabel{margin-top:8px;font-size:.9rem;color:#555}
  </style>
</head>

<body>
  <!-- top bar -->
  <div class="header">
    <div class="title">Dashboard</div>
    <div>
      <button class="home-btn" onclick="location.href='https://ehmsukalitesi.online'">Home</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- main -->
  <div class="main">
    <!-- chart -->
    <div class="chart-container">
      <h2>Temperature Over Time</h2>
      <canvas id="tempChart"></canvas>
    </div>

    <!-- slider -->
    <div class="slider-container">
      <h3>Filter by Time Frame</h3>
      <input type="range" id="timeSlider" min="0" max="4" value="0" />
      <div id="timeLabel">Last 10 minutes</div>
    </div>
  </div>

  <script>
    /* ----------------------------------------------------------- *
     *  GUARD: redirect to login if token missing
     * ----------------------------------------------------------- */
    const token = localStorage.getItem('token');
    if (!token) location.href = '/dashboard/login.html';

    /* ----------------------------------------------------------- *
     *  LOGOUT
     * ----------------------------------------------------------- */
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      location.href = '/dashboard/login.html';
    });

    /* ----------------------------------------------------------- *
     *  CHART
     * ----------------------------------------------------------- */
    const ctx = document.getElementById('tempChart').getContext('2d');
    const tempChart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{
        label: 'Temperature (°C)',
        data: [],
        borderColor: '#FF6B6B',
        tension: .15, fill:false, pointRadius:3
      }]},
      options: { responsive:true, maintainAspectRatio:false,
        scales:{ x:{ title:{display:true,text:'Time'}},
                 y:{ title:{display:true,text:'°C'}}}}
    });

    /* ----------------------------------------------------------- *
     *  TIME-RANGE SLIDER
     * ----------------------------------------------------------- */
    const timeSlider = document.getElementById('timeSlider');
    const timeLabel  = document.getElementById('timeLabel');
    const timeTexts  = ['Last 10 minutes','Last 30 minutes','Last 2 hours',
                        'Last 1 day','Last 1 week'];
    const minutesWin = [10, 30, 120, 1440, 10080]; // same indexes

    timeSlider.addEventListener('input', () => {
      timeLabel.textContent = timeTexts[timeSlider.value];
      drawChart();                                      // re-filter
    });

    /* ----------------------------------------------------------- *
     *  DATA HANDLING
     * ----------------------------------------------------------- */
    let fullData = [];                                  // [{ts, val}, …]

    async function fetchData() {
      try {
        const res = await fetch('/api/sensor-data',
          { headers: { 'Authorization': 'Bearer ' + token } });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const rows = await res.json();                  // [{type,timestamp,value} …]

        fullData = rows
          .filter(r => r.type === 'temperature')
          .map(r => ({ ts:new Date(r.timestamp), val:Number(r.value) }))
          .sort((a,b)=>a.ts-b.ts);                      // oldest → newest

        drawChart();
      } catch (err) {
        console.error('fetch error', err);
        if (err.message.includes('401')) {
          localStorage.removeItem('token');
          location.href = '/dashboard/login.html';
        }
      }
    }

    function drawChart() {
      const idx    = Number(timeSlider.value);
      const cutoff = Date.now() - minutesWin[idx] * 60_000;

      const dataWin = fullData.filter(p => p.ts.getTime() >= cutoff);

      tempChart.data.labels = dataWin.map(p =>
        p.ts.toLocaleTimeString('tr-TR', { hour:'2-digit', minute:'2-digit', second:'2-digit' })
      );
      tempChart.data.datasets[0].data = dataWin.map(p => p.val);
      tempChart.update();
    }

    /* initial + polling every 5 s */
    fetchData();
    setInterval(fetchData, 5000);
  </script>
</body>
</html>
