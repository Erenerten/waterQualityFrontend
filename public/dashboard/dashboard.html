<!-- public/dashboard/dashboard.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>SuKaliteX | Sıcaklık Paneli (DEBUG)</title>
  <meta http-equiv="Cache-Control" content="no-store" />

  <!-- libs -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{--dark:#0a2342;--gray:#f8fafc;--text:#223;--accent:#00b4d8;
          --success:#2ecc71;--warning:#f39c12;--danger:#e74c3c}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Poppins,sans-serif;background:var(--gray);color:var(--text);
         display:flex;height:100vh;overflow:hidden}

    /* sidebar */
    .sidebar{width:250px;background:var(--dark);color:#fff;padding:20px 16px;
             display:flex;flex-direction:column;gap:18px}
    .logo{display:flex;align-items:center;font-weight:600;font-size:1.3rem}
    .logo img{height:52px;margin-right:10px}
    .sensor-box{background:rgba(255,255,255,.08);padding:14px;border-radius:10px;
                border-left:3px solid var(--accent)}
    .sensor-value{font-size:1.3rem;font-weight:600;margin:4px 0}
    .sensor-unit{font-size:.75rem;opacity:.8}
    .sensor-status{font-size:.65rem;padding:2px 6px;border-radius:14px;background:var(--success)}

    /* main layout */
    .main{flex:1;display:flex;flex-direction:column}
    .top-bar{padding:10px 20px;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.05);
             display:flex;justify-content:space-between}
    .content{flex:1;display:flex;overflow:hidden}
    .map-wrap{flex:1.1;min-width:360px}
    #map{width:100%;height:100%}
    .chart-wrap{flex:1;padding:18px 20px;background:#fff;display:flex;flex-direction:column}
    .chart-title{font-size:1.1rem;margin-bottom:8px}
    .chart-box{flex:1;position:relative;min-height:240px}
    #sensorChart{flex:1}
  </style>
</head>

<body>
  <!-- sidebar -->
  <aside class="sidebar">
    <div class="logo"><img src="/images/logo.png" alt="logo"><span>SuKaliteX</span></div>

    <div class="sensor-box" id="tempBox">
      <div class="sensor-header">
        <h4>Sıcaklık</h4>
        <span class="sensor-status" id="tempStatus">—</span>
      </div>
      <div class="sensor-value" id="tempVal">-- <span class="sensor-unit">°C</span></div>
    </div>
  </aside>

  <!-- main -->
  <section class="main">
    <div class="top-bar"><span id="clock">--:--</span></div>

    <div class="content">
      <div class="map-wrap"><div id="map"></div></div>

      <div class="chart-wrap">
        <div class="chart-title">Sıcaklık Verileri</div>
        <div class="chart-box"><canvas id="sensorChart"></canvas></div>
      </div>
    </div>
  </section>

  <script>
    /* ─── auth guard ─── */
    const TOKEN = localStorage.getItem('token');
    if (!TOKEN) location.href = '/dashboard/login.html';

    /* ─── clock ─── */
    setInterval(()=>{
      document.getElementById('clock').textContent =
        new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
    },1000);

    /* ─── map ─── */
    const map=L.map('map').setView([41.03,28.89],15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      {attribution:'© OpenStreetMap'}).addTo(map);
    L.marker([41.03,28.89]).addTo(map).bindPopup('Ölçüm Noktası');

    /* ─── chart ─── */
    const ctx=document.getElementById('sensorChart').getContext('2d');
    const chart=new Chart(ctx,{type:'line',
      data:{labels:[],datasets:[{data:[],borderColor:'#0066cc',borderWidth:2,
                                tension:.3,fill:false,pointRadius:3}]},
      options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}}}}});
    const MAX=120;
    function pushTemp(ts,val){
      chart.data.labels.push(ts);
      chart.data.datasets[0].data.push(val);
      if(chart.data.labels.length>MAX){
        chart.data.labels.shift(); chart.data.datasets[0].data.shift();
      }
      chart.update();
    }

    /* ─── sidebar ─── */
    function updateSidebar(v){
      document.getElementById('tempVal').innerHTML =
        `${v.toFixed(1)} <span class="sensor-unit">°C</span>`;
      const st=document.getElementById('tempStatus');
      if(v>26){st.textContent='Tehlikeli';st.style.background='var(--danger)';}
      else if(v>24){st.textContent='Yüksek';st.style.background='var(--warning)';}
      else      {st.textContent='Normal';  st.style.background='var(--success)';}
    }

    /* ─── helper ─── */
    const toNum = raw=>{
      if(typeof raw==='number') return raw;
      if(typeof raw==='string'){
        const m=raw.replace(',','.').match(/[-+]?\d*\.?\d+/);
        return m?parseFloat(m[0]):NaN;
      }
      return NaN;
    };

    /* ─── last timestamp we've displayed ─── */
    let lastSeenIso = '';

    /* ─── initial history + live polling ─── */
    async function loadAndPoll(){
      try{
        const res = await fetch('/api/sensor-data',
          {headers:{Authorization:'Bearer '+TOKEN}});
        const rows = await res.json();

        /* -------- initial history (first run only) -------- */
        if(chart.data.labels.length===0){
          const past = rows
            .filter(r=>String(r.type||'').toLowerCase().includes('temp'))
            .map(r=>{
              const v = toNum(r.value ?? r.temperature);
              return Number.isFinite(v)? {iso:r.timestamp,val:v}:null;
            })
            .filter(Boolean)
            .slice(-MAX);                 // last 120 readings

          past.forEach(p=>{
            const ts=new Date(p.iso).toLocaleTimeString('tr-TR');
            pushTemp(ts,p.val);
            lastSeenIso = p.iso;          // remember newest
          });

          if(past.length) updateSidebar(past.at(-1).val);
        }

        /* -------- live append -------- */
        const newest = [...rows].reverse()
          .find(r=>String(r.type||'').toLowerCase().includes('temp'));

        if(!newest || newest.timestamp===lastSeenIso) return; // nothing new

        let val = toNum(newest.value ?? newest.temperature);
        if(!Number.isFinite(val) || val<-50 || val>150) return;

        lastSeenIso = newest.timestamp;
        pushTemp(new Date(newest.timestamp).toLocaleTimeString('tr-TR'),val);
        updateSidebar(val);

      }catch(e){console.error('poll error',e);}
    }
    loadAndPoll(); setInterval(loadAndPoll,5000);

    /* ─── debug output every 10 s ─── */
    async function debugSensorApi(){
      try{
        const r=await fetch('/api/sensor-data',{headers:{Authorization:'Bearer '+TOKEN}});
        console.log('↩︎ status',r.status);
        const t=await r.text();
        console.log('↩︎ raw:',t.slice(0,300)+(t.length>300?' …':''));
      }catch(e){console.error('debug',e);}
    }
    debugSensorApi(); setInterval(debugSensorApi,10000);
  </script>
</body>
</html>
