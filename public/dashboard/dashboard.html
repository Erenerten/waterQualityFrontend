<!-- public/dashboard/dashboard.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <title>SuKaliteX Pro | Akıllı Su Kalitesi İzleme Paneli</title>

  <!-- Fonts & libs -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-LrjY1X1PhgumU0NhmWUf+Qpa3kBgigvSKk/suK6azpi/LDQa5qf82x0tMgPvXK02s/7VW3T0+BA05ARXbCnQkQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>

  <!-- ➊  The long CSS is unchanged – snipped for brevity -->
  <style>/* … existing CSS … */</style>
</head>

<body>
  <!-- ===== SIDEBAR ==================================================== -->
  <div class="sidebar">
    <div class="toggle-sidebar" onclick="toggleSidebar()">
      <i class="fas fa-chevron-left"></i>
    </div>
    <div class="logo" onclick="toggleSidebar()">
      <img src="images/logo.png" alt="SuKaliteX Logo" style="height:60px;margin-right:10px" />
      <span>SuKaliteX</span>
    </div>

    <div class="sensor-container">
      <!-- Temperature -->
      <div class="sensor-box active" data-type="temperature" onclick="showSensorDetails('temperature')">
        <div class="sensor-header">
          <h3><i class="fas fa-thermometer-half"></i> Su Sıcaklığı</h3>
          <span class="sensor-status status-normal">Normal</span>
        </div>
        <div class="sensor-value">-- <span class="sensor-unit">°C</span></div>
      </div>
      <!-- Turbidity -->
      <div class="sensor-box" data-type="turbidity" onclick="showSensorDetails('turbidity')">
        <div class="sensor-header">
          <h3><i class="fas fa-water"></i> Bulanıklık</h3>
          <span class="sensor-status status-normal">Normal</span>
        </div>
        <div class="sensor-value">-- <span class="sensor-unit">NTU</span></div>
      </div>
      <!-- TDS / Conductivity -->
      <div class="sensor-box" data-type="conductivity" onclick="showSensorDetails('conductivity')">
        <div class="sensor-header">
          <h3><i class="fas fa-bolt"></i> TDS / İletkenlik</h3>
          <span class="sensor-status status-normal">Normal</span>
        </div>
        <div class="sensor-value">-- <span class="sensor-unit">ppm</span></div>
      </div>
      <!-- Leak -->
      <div class="sensor-box" data-type="leak" onclick="showSensorDetails('leak')">
        <div class="sensor-header">
          <h3><i class="fas fa-tint-slash"></i> Sızıntı</h3>
          <span class="sensor-status status-normal">Yok</span>
        </div>
        <div class="sensor-value">-</div>
      </div>
    </div>
  </div>

  <!-- ===== MAIN CONTENT =============================================== -->
  <div class="main-content">
    <div class="top-bar">
      <div class="time-display"><i class="far fa-clock"></i> <span id="current-time">--:--</span></div>
      <div class="battery-loader">
        <div class="battery-percent">87%</div>
        <div class="loader"></div>
      </div>
    </div>

    <div class="content-area">
      <!-- MAP -->
      <div class="map-container">
        <div id="map"></div>
        <div class="map-controls">
          <button type="button" onclick="toggleHeatmap()"><i class="fas fa-fire"></i> Isı Haritası</button>
          <button type="button" onclick="centerMap()"><i class="fas fa-crosshairs"></i> Merkezle</button>
          <button type="button" onclick="showAllSensors()"><i class="fas fa-map-marker-alt"></i> Tüm Sensörler</button>
        </div>
      </div>

      <!-- CHART & DETAILS -->
      <div class="graph-container">
        <h3 class="graph-title">
          <span id="graph-title">Su Sıcaklığı Verileri</span>
          <select id="time-range" onchange="updateChartRange()">
            <option value="24">Son 24 Saat</option>
            <option value="168">Son 7 Gün</option>
            <option value="720">Son 30 Gün</option>
          </select>
        </h3>

        <div class="chart-wrapper"><div class="chart-container"><canvas id="sensorChart"></canvas></div></div>

        <div class="sensor-info">
          <div class="info-card"><h4>Son Ölçüm</h4><p id="detail-last">--</p></div>
          <div class="info-card"><h4>Ortalama</h4><p id="detail-avg">--</p></div>
          <div class="info-card"><h4>Minimum</h4><p id="detail-min">--</p></div>
          <div class="info-card"><h4>Maksimum</h4><p id="detail-max">--</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- NOTIFICATION -->
  <div class="notification" id="notification"><div id="notification-message">---</div></div>

  <!-- ================= SCRIPTS ======================================== -->
  <script>
  /*---------------------------------------------------------------------
   *  BASIC UTILITIES & AUTH
   *-------------------------------------------------------------------*/
  const token = localStorage.getItem('token');
  if (!token) location.href = '/dashboard/login.html';

  const notify = (msg) => {
    const n = document.getElementById('notification');
    document.getElementById('notification-message').textContent = msg;
    n.classList.add('show');
    setTimeout(() => n.classList.remove('show'), 3000);
  };

  /*---------------------------------------------------------------------
   *  MAP INITIALISATION
   *-------------------------------------------------------------------*/
  let map, userMarker, heatmapLayer, isHeatmapVisible = false;
  const sensorMarkers = []; // [{marker,lat,lng,type,value}]
  function initMap() {
    const center = [41.0288603, 28.8877531];
    map = L.map('map').setView(center, 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap contributors', maxZoom:18
    }).addTo(map);

    userMarker = L.circleMarker(center,{
      radius:12,fillColor:'#0066cc',color:'#fff',weight:3,fillOpacity:1
    }).addTo(map).bindPopup('<b>ÖLÇÜM PROBU-1</b><br>Ana İzleme Noktası').openPopup();

    // demo secondary markers (optional)
    const demo = [
      {lat:41.029,lng:28.888,type:'temperature',name:'Şube 1'},
      {lat:41.028,lng:28.886,type:'temperature',name:'Şube 2'},
      {lat:41.027,lng:28.887,type:'temperature',name:'Şube 3'}
    ];
    demo.forEach(d=>{
      const m = L.circleMarker([d.lat,d.lng],{radius:10,fillColor:'#2ecc71',color:'#fff',
                  weight:2,fillOpacity:1}).addTo(map)
                .bindPopup(`<b>${d.name}</b><br>--`);
      sensorMarkers.push({marker:m,lat:d.lat,lng:d.lng,type:d.type,value:0});
    });

    heatmapLayer = L.heatLayer([], {radius:25,blur:15,maxZoom:17,
      gradient:{.4:'blue',.6:'lime',.8:'yellow',1:'red'}});
  }

  /*---------------------------------------------------------------------
   *  SIDEBAR UPDATE
   *-------------------------------------------------------------------*/
  function updateSidebar(sensorType, value){
    if (value == null) return;  // nothing to show yet

    const box = document.querySelector(`.sensor-box[data-type="${sensorType}"]`);
    if(!box) return;

    const unit = box.querySelector('.sensor-unit')?.textContent.trim() || '';
    box.querySelector('.sensor-value').innerHTML = `${value.toFixed(1)} ${unit}`;
    const statusEl = box.querySelector('.sensor-status');

    if(sensorType === 'temperature'){
      if(value > 26){ statusEl.textContent='Tehlikeli'; statusEl.className='sensor-status status-danger'; }
      else if(value > 24){ statusEl.textContent='Yüksek'; statusEl.className='sensor-status status-warning'; }
      else{ statusEl.textContent='Normal'; statusEl.className='sensor-status status-normal'; }
    } else if(sensorType === 'conductivity'){
      if(value > 1200){ statusEl.textContent='Yüksek'; statusEl.className='sensor-status status-warning'; }
      else{ statusEl.textContent='Normal'; statusEl.className='sensor-status status-normal'; }
    }
  }

  /*---------------------------------------------------------------------
   *  CHART
   *-------------------------------------------------------------------*/
  const sensorCtx = document.getElementById('sensorChart').getContext('2d');
  const sensorChart = new Chart(sensorCtx,{
    type:'line',
    data:{labels:[],datasets:[{data:[],borderColor:'#0066cc',borderWidth:2,
                               tension:.4,fill:false,pointRadius:0,pointHoverRadius:5}]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{y:{title:{display:true,text:'Sıcaklık (°C)'}},
              x:{grid:{display:false}}}
    }
  });

  function pushChartValue(val){
    const now = new Date().toLocaleTimeString('tr-TR');
    sensorChart.data.labels.push(now);
    sensorChart.data.datasets[0].data.push(val);
    if(sensorChart.data.labels.length > 30){
      sensorChart.data.labels.shift();
      sensorChart.data.datasets[0].data.shift();
    }
    sensorChart.update();
  }

  /*---------------------------------------------------------------------
   *  DATA FETCH (pure REST polling)
   *-------------------------------------------------------------------*/
  async function fetchLiveData(){
    try{
      const res = await fetch('/api/sensor-data',{headers:{Authorization:'Bearer '+token}});
      if(!res.ok) throw new Error('fetch error '+res.status);
      const data = await res.json();            // expect [{type,value,timestamp}, …]
      applySensorUpdate(data);
    }catch(e){
      console.error('REST polling failed', e);
      notify('Sensör verileri alınamadı');
    }
  }

  function applySensorUpdate(arr){
    const grouped = {};
    arr.forEach(d => grouped[d.type] = d);

    ['temperature','turbidity','conductivity'].forEach(t => {
      if(grouped[t]) updateSidebar(t, grouped[t].value);
    });

    if(grouped.temperature) pushChartValue(grouped.temperature.value);
    updateHeatmap();
  }

  /*---------------------------------------------------------------------
   *  HEATMAP & MAP HELPERS
   *-------------------------------------------------------------------*/
  function updateHeatmap(){
    const pts = sensorMarkers.map(s=>[s.lat,s.lng,(s.value || 22)/10]);
    heatmapLayer.setLatLngs(pts);
  }
  function toggleHeatmap(){
    if(isHeatmapVisible){ map.removeLayer(heatmapLayer); }
    else{ map.addLayer(heatmapLayer); }
    isHeatmapVisible = !isHeatmapVisible;
  }
  const centerMap = () => map.setView(userMarker.getLatLng(),15);
  const showAllSensors = () => map.fitBounds(L.featureGroup(sensorMarkers.map(s=>s.marker)).getBounds().pad(.2));

  /*---------------------------------------------------------------------
   *  OTHER UI HELPERS
   *-------------------------------------------------------------------*/
  let sidebarCollapsed = false;
  function toggleSidebar(){
    const sb = document.querySelector('.sidebar');
    sb.classList.toggle('collapsed');
    sidebarCollapsed = !sidebarCollapsed;
    const icon = document.querySelector('.toggle-sidebar i');
    icon.classList.toggle('fa-chevron-left', !sidebarCollapsed);
    icon.classList.toggle('fa-chevron-right', sidebarCollapsed);
  }
  function updateTime(){
    document.getElementById('current-time').textContent =
      new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
  }
  setInterval(updateTime, 1000);

  function showSensorDetails(t){
    document.querySelectorAll('.sensor-box').forEach(b=>b.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById('graph-title').textContent={
      temperature:'Su Sıcaklığı Verileri',
      turbidity:'Bulanıklık Verileri',
      conductivity:'TDS / İletkenlik Verileri',
      leak:'Sızıntı Durumu'
    }[t] || 'Sensör Verileri';
  }
  const updateChartRange = () => {}; // placeholder – implement later if needed

  /*---------------------------------------------------------------------
   *  BOOTSTRAP
   *-------------------------------------------------------------------*/
  document.addEventListener('DOMContentLoaded',()=>{
    initMap();
    updateTime();
    fetchLiveData();               // first shot
    setInterval(fetchLiveData, 10000);
    notify('REST polling başlatıldı');
  });
  </script>
</body>
</html>